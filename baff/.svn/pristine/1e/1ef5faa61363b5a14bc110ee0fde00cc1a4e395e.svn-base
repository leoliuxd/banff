var util=require('../../../utils/util.js')
var app = getApp()
Page({
    data:{
        search_inputShowed: false,
        search_inputVal: "",
        scrollHeight:0,

        isShowList:true,
        switchMode:'',
        _place: [],
        place_id:0,
        selectedPlace:{},
        placeIndex: 0,

        _live:[],
        live:[
            {'id':'food',name:'美食'},
            {id:'shop',name:'购物'},
            {id:'culture',name:'文化'},
            {id:'fitness',name:'健身'},
            {id:'accommodation',name:'住宿'},
            {id:'entertainment',name:'娱乐'},
            {id:'scenery',name:'风景'},
            {id:'all',name:'全部'},
        ],
        liveIndex:0,

        list:[],
        page:1,
        isMoreData:'',

    },

    onLoad:function(res){
        var that=this
        this.getLiveHeader()
        this.getLiveContent(parseInt(this.data.placeIndex) + 1, res.id, parseInt(this.data.page))
        wx.getSystemInfo({
          success: function (res) {
            that.setData({
              scrollHeight: res.windowHeight,
              switchMode: '地图',
            });
          }
        });
    },

   // 搜索
    showInput: function () {
        this.setData({
            search_inputShowed: true
        });
    },
    hideInput: function () {
      this.setData({
          search_inputVal: "",
          search_inputShowed: false
      });
    },
    clearInput: function () {
      this.setData({
          search_inputVal: ""
      });
    },
    inputTyping: function (e) {
      this.setData({
          search_inputVal: e.detail.value
      });
      console.log('e.detail.value')
    },

     search:function(e){
       this.setData({
         page:1,
       })
       if (e.detail.value != ''){
         wx.showToast({
           title: '加载中',
           icon: 'loading',
           duration: 1000
         })
         this.getLiveContent(parseInt(this.data.placeIndex) + 1, parseInt(this.data.liveIndex) + 1, parseInt(this.data.page), e.detail.value)
       }else{
         wx.showModal({
           title: '提示',
           content: '暂无该项，请搜索其他项！',
           showCancel:false,
         })

       }
     },

    //地图
    switch:function(e){
        if(this.data.isShowList == true){
            this.setData({
                isShowList:false,
                switchMode:'列表',
            })
        }else{
            this.setData({
            isShowList:true,
            switchMode:'地图',
        })
        }
        
    },

    //选择器
    placeChange: function(e) {
      this.getLiveContent(parseInt(e.detail.value) + 1, parseInt(this.data.liveIndex) + 1, parseInt(this.data.page))
        this.setData({
            placeIndex: e.detail.value,
            page:1,
        })
    },

    liveChange:function(e){
      this.getLiveContent(parseInt(this.data.placeIndex) + 1, parseInt(e.detail.value) + 1, parseInt(this.data.page))
        this.setData({
            liveIndex: e.detail.value,
            page:1,
        })
    },

    getLiveHeader: function (){
      var that=this
      if (app.cache['_place']) { PlaceAndLiveRender(app.cache['_place']) }

      //渲染列表头
      function PlaceAndLiveRender(info){
        var _place = []
        var _live = []
        for (var i in info) {
          _place.push(info[i].name)
        }

        for (var i in app.cache['live']) {
          _live.push(app.cache['live'][i].name)
        }
        that.setData({
          _place: _place,
          _live: _live
        })
      }

      //获取列表头数据
      wx.request({
        url: 'http://www.banfflakelouise.cn/m/place/regions',
        success: function (res) {
          if (res.data) {
            var info = res.data;
            if (info) {
              app.saveCache('_place', info);
              PlaceAndLiveRender(info)
            }
          } else { app.removeCache('_place'); }
        }
      })

      
    },

    getLiveContent: function (id, category_id, page,words=''){
      var that = this
      //渲染列表数据
      function contentRender(info) {
        var list = app.cache['selectedPlace']
        that.setData({
          list: list,
        })
      }

      //获取列表数据
      //console.log('区域id: ' + id)
      //console.log('分类id: ' + category_id)
      wx.request({
        url: 'http://www.banfflakelouise.cn/m/place/places?region_id=' + id + '&category_id=' + category_id + '&page'+page+'&size=4'+'&words='+words,
        success: function (res) {
          if (res.data) {
            var info = res.data;
            if (info.length != 0) {
              app.saveCache('selectedPlace', info);
              contentRender(info)
            }else{
              wx.showModal({
                title: '提示',
                content: '暂无该项，请搜索其他项！',
                showCancel: false,
              })
              app.removeCache('selectedPlace');
              contentRender(info)  
            }
          } 
        },
        complete:function(res){
          if(words != '' && res.data.length != 0){
            setTimeout(function () {
              wx.showToast({
                title: '加载完成！',
                icon: 'success',
                duration: 1000
              })
            }, 1000)
          }
        }
      })
    },

    //列表内容动态加载
    lower: function (e) {
       wx.showNavigationBarLoading();
       var that = this;
       setTimeout(function () { wx.hideNavigationBarLoading(); that.nextLoad(); }, 1000);
       console.log("lower")
     },

     nextLoad: function () {
       var that=this
       wx.showToast({
         title: '加载中',
         icon: 'loading',
         duration: 2000
       })

       var page=this.data.page
       page=page+1
       this.setData({
         page:page
       })

       this.getLiveContentNext(parseInt(this.data.placeIndex) + 1, parseInt(this.data.liveIndex) + 1, parseInt(this.data.page))
       
       
     },

     getLiveContentNext: function (id, category_id, page,words='') {
       var that = this
       //渲染列表数据
       function contentRender(info) {
         var list = that.data.list.concat(info)
         app.saveCache('selectedPlace',list)
         that.setData({
           list: list,
           isMoreData:'加载成功！'
         })
       }

       //获取列表数据
       wx.request({
         url: 'http://www.banfflakelouise.cn/m/place/places?region_id=' + id + '&category_id=' + category_id + '&page=' + page + '&size=3' + '&words=' + words,
         success: function (res) {
           if (res.data) {
             var info = res.data;
             if (info.length !=0 ) {
               contentRender(info)
             } else 
             {
               console.log('已经没有数据了！')
               that.setData({
                 isMoreData: '已经没有数据了！'
               })
             } 
           }
         },
         complete:function(){
           setTimeout(function () {
             wx.showToast({
               title: that.data.isMoreData,
               icon: 'success',
               duration: 1000
             })
           }, 1000)
         }
       })
     },



})